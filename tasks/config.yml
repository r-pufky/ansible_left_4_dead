---
###############################################################################
# Config
###############################################################################
# INI files contain duplicate keys (violating the INI standard). Files are
# deleted and re-created with exclusive disabled to prevent infinite duplicate
# key growth in configs.
#
# Reference:
# * https://satisfactory.wiki.gg/wiki/Dedicated_servers#Linux
# * https://satisfactory.wiki.gg/wiki/Dedicated_servers/Running_as_a_Service
# * https://satisfactory.wiki.gg/wiki/Dedicated_servers/Configuration_files

- name: 'Config | set motd.txt'
  ansible.builtin.copy:
    dest: '{{ _left_4_dead.base ~ "/motd.txt" }}'
    owner: '{{ _left_4_dead.uid }}'
    group: '{{ _left_4_dead.gid }}'
    mode: '0644'
    content: '{{ left_4_dead_cfg_motd }}'

- name: 'Config | set host.txt'
  ansible.builtin.copy:
    dest: '{{ _left_4_dead.base ~ "/host.txt" }}'
    owner: '{{ _left_4_dead.uid }}'
    group: '{{ _left_4_dead.gid }}'
    mode: '0644'
    content: '{{ left_4_dead_cfg_host }}'

- name: 'Config | set server.cfg'
  ansible.builtin.template:
    src: 'server.cfg.j2'
    dest: '{{ _left_4_dead.config ~ "/server.cfg" }}'
    owner: '{{ _left_4_dead.uid }}'
    group: '{{ _left_4_dead.gid }}'
    mode: '0644'
  vars:
    server: '{{ left_4_dead_cfg_server }}'

- name: 'Config | set admins_simple.ini'
  when: left_4_dead_srv_sourcemod_enable
  ansible.builtin.template:
    src: 'admins_simple.ini.j2'
    dest: '{{ _left_4_dead.sm_admin_config }}'
    owner: '{{ _left_4_dead.uid }}'
    group: '{{ _left_4_dead.gid }}'
    mode: '0600'

- name: 'Config | create service'
  ansible.builtin.include_role:
    name: 'r_pufky.deb.systemd'
  vars:
    systemd_daemon_reload_enable: true
    systemd_services:
      - name: 'left_4_dead'
        state: 'present'
        drop_in: false
        unit:
          description: 'Left 4 Dead Dedicated Server'
          after:
            - 'network.target'
        service:
          type: 'simple'
          exec_start_pre:
            - >-
              /usr/games/steamcmd
              +@sSteamCmdForcePlatformType {{ left_4_dead_role_platform }}
              +force_install_dir {{ left_4_dead_srv_root }}
              +login anonymous
              +app_update {{ left_4_dead_role_app_id }}
              {{ left_4_dead_srv_extra_opts }}
              +quit
          exec_start:
            - >-
              {{ left_4_dead_srv_root }}/srcds_run
              +console
              +game left4dead
              {{ left_4_dead_srv_launch_options | join(" ") }}
              +exec server.cfg
              +pidfile /tmp/left_4_dead.pid
          pid_file: '/run/left_4_dead.pid'
          timeout_start_sec: 'infinity'
          restart: 'always'
        exec:
          # limitNOFILE default is 524288 in Trixie.
          user: '{{ _left_4_dead.user }}'
          group: '{{ _left_4_dead.group }}'
          working_directory: '{{ left_4_dead_srv_root }}'
          environment:
            - var: 'LD_LIBRARY_PATH'
              value:
                '{{ left_4_dead_srv_root }}:{{ left_4_dead_srv_root }}/bin'
        install:
          wanted_by:
            - 'multi-user.target'

- name: 'Config | flush handlers'
  ansible.builtin.meta: 'flush_handlers'

- name: 'Config | start services'
  ansible.builtin.systemd:
    name: 'Config | {{ item }}'
    enabled: true
    daemon_reload: true
    state: 'started'
  failed_when: false
  loop:
    - 'left_4_dead.service'
